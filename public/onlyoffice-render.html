<html>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
<!--
    *
    * (c) Copyright Ascensio System SIA 2021
    *
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    *     http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    *
-->
<title>Kyso OnlyOffice Renderer</title>

<script id="scriptApi" type="text/javascript"
    src="/web-apps/apps/api/documents/api.js"></script>

<script type="text/javascript">
/**
 *
 * (c) Copyright Ascensio System SIA 2021
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

  const urlParams = new URLSearchParams(window.location.search);
  const fileParam = urlParams.get('file');

  function initEditor(docKey, mode, type) {
    //mode for editor
    window.mode = window.mode || mode || "view";
    mode = window.mode;
    //mode for editor
    window.type = window.type || type || "";
    type = window.type;
    //url for document
    window.docUrl = fileParam
    //key for chaching and collaborate editing
    window.docKey = window.docKey || docKey || key(docUrl);
    docKey = window.docKey;
    //type for document
  let queryIdx = docUrl.lastIndexOf("?");
  let fileName;
	if (queryIdx < 0) {
	    fileName = docUrl.substring(docUrl.lastIndexOf("/") + 1).trim();
    } else {
	    fileName = docUrl.substring(docUrl.lastIndexOf("/") + 1, queryIdx).trim();
    }
    let docType = fileName.substring(fileName.lastIndexOf(".") + 1).toLowerCase();
    //type for editor
    let documentType = getDocumentType(docType);
    
    //creating object editing
    new DocsAPI.DocEditor("placeholder",
        {
            type: type,
            width: "100%",
            height: "100%",
            documentType: documentType,
            document: {
                title: fileName,
                url: docUrl,
                fileType: docType,
                key: docKey,
                permissions: { 
                    chat: false,
                    comment: false,
                    copy: false,
                    deleteCommentAuthorOnly: false,
                    download: true,
                    edit: false,
                    editCommentAuthorOnly: false,
                    fillForms: false,
                    modifyContentControl: false,
                    modifyFilter: false,
                    print: true,
                    protect: false,
                    review: false,
                }
            },
            editorConfig: {
                coEditing: { change: false },
                mode: mode,
                customization: {
					          anonymous: {
                        request: false,
                        label: "User"
                    },
                    autosave: false,
                    comments: false,
                    compactHeader: true,
                    compactToolbar: true,
                    compatibleFeatures: false,
                    features: { spellcheck: { mode: false, change: false } },
                    feedback: { visible: false },
                    forcesave: false,
                    help: false,
                    hideNotes: true,
                    hideRightMenu: true,
                    hideRulers: true,
                    macros: false,
					          macrosMode: "disable",
                    mentionShare: false,
                    plugins: false,
                    review: {
                        hideReviewDisplay: true,
                        showReviewChanges: true,
                        trackChanges: false,
                        hoverMode: false,
                    },
                    toolbarHideFileName: true,
                    toolbarNoTabs: true,
                },
                embedded: {
					        toolbarDocked: "bottom"
                },
				plugins: {
				}
            }
        });
}

function key(k) {
    let result = k.replace(new RegExp("[^0-9-.a-zA-Z_=]", "g"), "_") + (new Date()).getTime();
    return result.substring(result.length - Math.min(result.length, 20));
};

let getDocumentType = function (ext) {
    if (".doc.docx.docm.dot.dotx.dotm.odt.fodt.ott.rtf.txt.html.htm.mht.xml.djvu.fb2.epub.xps.oxps".indexOf(ext) != -1) return "word";
    if (".xls.xlsx.xlsm.xlsb.xlt.xltx.xltm.ods.fods.ots.csv".indexOf(ext) != -1) return "cell";
    if (".pps.ppsx.ppsm.ppt.pptx.pptm.pot.potx.potm.odp.fodp.otp".indexOf(ext) != -1) return "slide";
    if (".pdf".indexOf(ext) != -1) return "word";
    return null;
};
</script>

</head>

<body>
    <div><div id="placeholder"></div></div>
</body>

<script type="text/javascript">
  initEditor(null, null, 'embedded')
</script>
</html>
